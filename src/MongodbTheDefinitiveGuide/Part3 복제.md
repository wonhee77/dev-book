# 10장 복제 셋 설정

## 10.1 복제 소개

서버가 고장나거나 이용 불가능한 상태가 될 수도 있고, 하드웨어에 문제가 있다면 데이터를 다른 서버로 옮겨야 할지도 모른다.

복제는 데이터의 동일한 복사본을 여러 서버상에서 보관하는 방법이며 실제 서비스를 배포할 때 권장된다.

몽고DB를 사용하면 복제 셋을 생성함으로써 복제를 설정할 수 있다. 복제 셋은 클라이언트 요청을 처리하는 프라이머리 서버 한 대와, 프라이머리 데이터의 복사본을 갖는 세컨더리 서버 여러대로 이뤄진다.

프라이머리 서버에 장애가 발생하면 세컨더리 서버는 자신들 중에서 새로운 프라이머리 서버를 선출할 수 있다.

## 10.2 복제 셋 설정 - 1장

운영 환경에서는 항상 복제 셋을 사용하며, 각 멤버에 전용 호스트를 할당해 리소스 경합을 방지하고 서버 오류에 대한 격리를 제공해야 한다.

테스트 복제 셋을 시작하기에 앞서 각 노드에 대해 별도의 데이터 디렉터리를 생성한다.

```jsx
$ mkdir -p ~/data/rs{1,2,3}
```

```jsx
# mongod --replSet modDefGuide --dbpath ~/data/rs1 --port 27017 \
--smallfiles --oplogSize 200
# mongod --replSet modDefGuide --dbpath ~/data/rs2 --port 27017 \
--smallfiles --oplogSize 200
# mongod --replSet modDefGuide --dbpath ~/data/rs3 --port 27017 \
--smallfiles --oplogSize 200
```

## 10.3 네트워크 고려 사항

복제 셋의 모든 멤버는 같은 셋 내 다른 멤버와 연결할 수 있어야 한다.

인스턴스를 각기 다른 서버의 멤버와 함께 복제 셋의 멤버로 실행하려면 명령행 매개변수 —bind_ip를 지정하거나 인스턴스 구성파일에 있는 bind_ip를 사용한다.

## 10.4 보안 고려 사항

[localhost](http://localhost) 이외의 IP 주소에 바인딩하기 전 복제 셋을 구성할 때, 권한 제어를 활성화하고 인증 매커니즘을 지정해야 한다. 또한 디스크의 데이터를 암호화하고, 복제 셋 멤버 간 통신 및 셋과 클라이언트 간 통신을 암호화하면 좋다.

## 10.5 복제 셋 설정 - 2장

지금까지 수행한 작업으로는 아직 각 mongod가 다른 mongod의 존재를 알지 못한다. 각 멤버를 나열하는 config를 만들어 mongod 프로세스 중 하나로 보내면 전달 받은 프로세스는 이를 다른 멤버들에게 전파한다.

복제 셋의 상태는 rs.status()를 사용해서 볼 수 있다.

rs는 복제 보조자 함수를 포함하는 전역 변수다. 이 함수들은 거의 항상 데이터베이스 명령을 감싸는 래퍼다.

## 10.6 복제 관찰

```jsx
mdbDefGuide:PRIMARY>
```

이는 “_id”가 “mdbDefGuide”인 복제 셋 프라이머리에 연결됐음을 뜻한다.

세컨더리에 접속할 때는 셸을 종료하고 세컨더리 포트 번호를 사용해 연결할 수도 있지만 실행 중인 셸 내에서 Mongo 생성자를 사용해 연결 객체를 인스턴스화하면 세컨더리에 대한 연결을 쉽게 얻을 수 있다.

먼저 프라이머리의 테스트 데이터베이스에 대한 연결을 사용해 isMaster() 명령을 실행하자.

```jsx
> db.isMaster()
```

[localhost](http://localhost) : 27019에 대한 연결을 인스턴스화 해보자.

```jsx
> secondaryConn = new Mongo("localhost:27019")
> secondayDB = secondaryConn.getDB("test)
```

이제 세컨더리로 복제된 컬렉션에 읽기를 시도하면 오류가 발생한다. 세컨더리는 프라이머리보다 뒤처지며 데이터가 최신이 아닐 수 있다. 세컨더리는 애플리케이션이 실수로 실효 데이터를 읽지 않도록 기본적으로 읽기 요청을 거부한다. 세컨더리에 대한 쿼리를 허용하며녀 다음의 플래그를 설정한다.

```jsx
> secondaryConn.setSlaveOk()
```

세컨더리는 클라이언트가 아닌 복제를 통해 가져오는 쓰기만 수행한다.

## 10.7 복제 셋 구성 변경

복제 셋 구성은 언제든지 변경할 수 있으며 멤버 추가, 삭제, 변경이 가능하다.

복제 셋에 새로운 멤버를 추가할 때는 rs.add를 사용한다.

```jsx
> rs.add("localhost:27020")
> rs.remove("localhost:27017") // 멤버 제거
> rs.config() // 현재 구성 출력
```

이미 존재하는 멤버를 수정할 수도 있다.

```jsx
> var config = rs.config()
> config.members[0].host = "localhost:27017"
> rs.reconfig(config)
```

## 10.8 복제 셋 설계 방법

프라이머리를 선출하려면 멤버의 과반수 이상이 필요하고, 프라이머리는 과반수 이상이어야만 프라이머리 자격을 유지할 수 있다. 과반이 죽어 있는 경우 과반이 실제로 연결이 잠시 동안만 끊어진 것일 수도 있기 때문이다.