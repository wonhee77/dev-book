# Part1 몽고DB 시작

## 1장 몽고DB 소개

### 1.1 손쉬운 사용

몽고DB는 분산 확장(Scale out)을 쉽게 하기 위한 도큐먼트 지향 데이터베이스다.

내장 도큐먼트와 배열을 허용함으로써 복잡한 계층 관계를 하나의 레코드로 표현할 수 있다.

고정된 스키마가 없으므로 필요할 때마다 쉽게 필드를 추가하거나 제거할 수 있다.

### 1.2 확장 가능한 설계

몽고DB는 분산 확장을 염두에 두고 설계됐다. 도큐먼트 지향 데이터 모델이기 때문

### 1.3 다양한 기능

인덱싱

고유, 복합, 공간 정보, 전문 인덱싱 기능 제공한다.  
중첩된 도큐먼트 및 배열과 같은 계층 구조의 보조 인덱스도 지원

집계

데이터 처리 파이프라인 개념을 기반으로 한 집계 프레임워크를 제공한다.

특수한 컬렉션 유형

로그와 같은 최신 데이터를 유지하고자 세션이나 고정 크기 컬렉션과 같이 특정 시간에 만료해야하는 데이터에 대해 유효 시간 컬렉션을 지원한다. 또한 criteria filter와 일치하는 도큐먼트에 한정된 partial index를 지원함으로써 효율성을 높이고 필요한 저장 공간을 줄인다.

파일 스토리지

큰 파일과 파일 메타데이터를 편리하게 저장하는 프로토콜을 지원한다.

### 1.4 고성능

몽고DB에서는 동시성과 처리량을 극대화하기 위해 wiredTiger storage engine에 opportunistic locking을 사용했다.  
따라서 캐시처럼 제한된 용량의 램으로 쿼리에 알맞은 인덱스를 자동으로 선택할 수 있다. 몽고DB는 모든 측면에서 고성능을 유지하기 위해 설계됐다.

일부 기능의 경우 데이터베이스 서버는 처리와 로직을 클라이언트 측에 오프로드한다.

### 1.5 몽고 DB의 철학

결국 몽고 DB 프로젝트의 주 관심사는 확장성이 높으며 유연하고 빠른, 즉 완전한 기능을 갖춘 데이터 스토리지를 만드는 일이다.

## 2장 몽고DB 기본

### 2.1 도큐먼트

몽고DB의 핵심은 정렬된 키와 연결된 값의 집합으로 이뤄진 **도큐먼트**다.

데이터형과 대소문자를 구분한다.

```jsx
{"count" : 5} 와 {"count" : "5"}는 다르다
{"Count" : 5} 와 {"count" : 5}는 다르다
```

키가 중복될 수 없다.

### 2.2 컬렉션

컬렉션은 도큐먼트의 모음이다.

**2.2.1 동적 스키마**

컬렉션은 동적 스키마를 가진다. 하나의 컬렉션 내 도큐먼트들이 모두 다른 구조를 가질 수 있다.

도큐먼트들의 키, 키의 개수, 데이터형이 모두 다른데 왜 별도의 컬렉션으로 나누는 이유

- 컬렉션 별로 목록을 뽑으면 한 컬렉션 내 특정 데이터형 별로 쿼리해서 목록을 뽑을 때 보다 훨씬 빠르다.
- 같은 종류의 데이터를 하나의 컬렉션에 모아두면 데이터의 지역성이 좋다.
- 인덱스를 만들면 도큐먼트는 특정 구조를 가져야 한다. 같은 유형의 도큐먼트를 하나의 컬렉션에 넣음으로써 컬렉션을 효율적으로 인덱싱할 수 있다.

**2.2.2 네이밍**

**서브컬렉션**

서브컬렉션의 네임스페이스에 마침표 문자(.)를 사용해 컬렉션을 체계화한다.

blog.post와 blog.authors라는 컬렉션을 가질 수 있으며 이는 단지 체계화 하기 위함이며 blog 컬렉션이나 자식 컬렉션과는 아무 관계가 없다.

### 2.3 데이터베이스

몽고DB는 컬렉션에 도큐먼트를 그룹화할 뿐 아니라 데이터베이스에 컬렉션을 그룹 지어 놓는다.

몽고DB의 단일 인스턴스는 여러 데이터베이스를 호스팅할 수 있으며, 각 데이터베이스를 완전히 독립적으로 취급할 수 있다.

한 애플리케이션의 데이터를 동일한 데이터베이스에 저장하는 것도 좋은 방식이지만 데이터베이스를 나누면 하나의 몽고DB 서버에서 여러 애플리케이션이나 여러 사용자가 데이터를 저장할 때 유용하다.

데이터베이스는 컬렉션과 마찬가지로 이름으로 식별되고, UTF-8 문자열을 사용할 수 있다.

직접 접근할 수는 있지만 특별한 의미론을 갖는 예약된 데이터베이스 이름도 있다.

admin

admin 데이터 베이스는 인증과 인가 역할을 한다.

local

local 데이터베이스는 단일 서버에 대한 데이터를 저장한다. Replica set에서 local은 replication 프로세스에 사용된 데이터를 저장한다. local 데이터베이스 자체는 복제되지 않는다.

config

샤딩된 몽고DB 클러스터는 config 데이터베이스를 사용해 각 샤드의 정보를 저장한다.

### 2.4 몽고DB 시작

서버를 실행하려면 유닉스 명령행 환경에서 mongod 실행파일을 실행한다.

mongod는 인수없이 실행하면 기본 데이터 디렉터리로 /data/db를 사용한다. 데이터 디렉터리가 존재하지 않거나 쓰기 권한이 없을 때는 서버가 시작되지 않는다.

시작할 때 서버는 버전과 시스템 정보를 출력한 후 클라이언트의 연결을 기다린다.

### 2.5 몽고DB 셸 소개

몽고DB는 명령행에서 몽고DB 인스턴스와 상호작용하는 자바스크립트 셸을 제공한다.

**2.5.1 셸 실행**

mongo를 실행해 셸을 시작한다.

셸은 시작하면 자동으로 로컬 장비에서 실행 중인 몽고DB 서버에 접속을 시도한다.

셸은 완전한 자바스크립트 해석기이며 임의의 자바스크립트 프로그램을 실행한다.

**2.5.2 몽고DB 클라이언트**

셸은 시작할 때 몽고DB 서버의 test 데이터베이스에 연결하고, 데이터베이스 연결을 전역 변수 db에 할당한다. 셸에서는 주로 이 변수를 통해 몽고DB에 접근한다.

현재 db에 할당된 데이터 베이스를 확인하려면 db를 입력한다.

```jsx
> db
```

데이터베이스 선택

```jsx
> user video
switched to db video
```

**2.5.3 셸 기본 작업**

셸에서 데이터를 조작하거나 보려면 생성, 읽기, 갱신, 삭제의 네 가지 기본적인 작업을 한다.

**생성**

insertOne 함수는 컬렉션에 도큐먼트를 추가한다.

우선 도큐먼트를 나타내는 자바스크립트 객체인 movie라는 지역 변수를 생성한다.

```jsx
> movie = {"title" : "Star wars",
...}
```

이 객체는 유효한 몽고DB 도큐먼트이며 insertOne 함수를 이용해 movies 컬렉션에 저장할 수 있다.

```jsx
> db.movies.insertOne(movie)
{
		"acknowledged" : true,
		"insertedId" : ObjectId("12342134asdf")
}
```

컬렉션에 find를 호출해서 확인할 수 있다.

```jsx
> db.movies.find().pretty()
```

**읽기**

find와 findOne은 컬렉션을 쿼리하는 데 사용한다. 컬렉션에서 단일 도큐먼트를 읽으려면 findOne을 사용한다.

find와 findOne은 쿼리 도큐먼트 형태로 조건 전달도 가능하다. 셸은 20개까지 자동으로 출력하지만 그 이상도 가져올 수 있다.

**갱신**

게시물을 갱신하려면 updateOne을 사용한다. updateOne의 매개변수는 최소 두 개다. 첫 번째는 수정할 다큐먼트를 찾는 기준이고, 두 번째는 갱신 작업을 설명하는 도큐먼트다.

```jsx
> db.movies.updateOne({title : "Star Wars"},...,{$set : {reviews : []}})
```

**삭제**

deleteOne과 deleteMany는 도큐먼트를 데이터베이스에서 영구적으로 삭제한다.

두 함수 모두 필터 도큐먼트로 삭제 조건을 지정한다.

## 2.6 데이터형

### 2.6.1 기본 데이터형

몽고DB에서 도큐먼트는 자바스크립트 객체와 개념적으로 닯았다는 점에서 JSON과 닮았다 라고 생각할 수 있다.

하지만 JSON은 데이터형이 null, 불리언, 숫자, 문자열, 배열, 객체만 지원하기 때문에 표현력이 제한적이다.

날짜형도 없고, 숫자형도 한가지 타입 밖에 없다. 또한 부동소수점형과 정수형을 표현하는 방법이 없고 32비트 64비트도 구별되지 않는다. 함수나 정규표현식과 같은 흔히 쓰는 데이터형을 표현하는 방법도 없다.

몽고DB는 JSON의 키/값 성질을 유지하면서 추가적인 데이터형을 지원한다.

다음 목록은 흔히 지원되는 데이터형이 셸에서 어떻게 도큐먼트의 일부로 표현되는지 나타낸다.

| 자료형 | 설명 |
| --- | --- |
| null | null 값과 존재하지 않는 필드를 표현하는 데 사용한다. |
| boolean | 참과 거짓 값에 사용한다. |
| 숫자 | 셸은 64비트 부동소수점 수를 기본으로 사용한다. |
| 문자열 | 어떤 UTF-8 문자열이든 문자열형으로 표현할 수 있다. |
| 날짜 | 1970년 1월 1일부터의 시간을 1/1000초 단위로 나타내는 64비트 정수로 날짜를 저장한다. 표준 시간대는 저장하지 않는다. |
| 정규표현식 | 자바스크립트의 정규 표현식 문법을 사용할 수 있다. |
| 배열 | 값의 set이나 list를 배열로  표현할 수 있다. |
| 내장 도큐먼트 | 도큐먼트는 부모 도큐먼트의 값으로 내장된 도큐먼트 전체를 포함할 수 있다. |
| 객체 ID | 객체 ID는 도큐먼트용 12바이트 ID다. ObjectId() |
| 이진 데이터  | 이진 데이터는 임의의 바이트 문자열이며 셸에서는 조작이 불가능하다. |
| 쿼리 | 쿼리와 도큐먼트는 임의의 자바스크립트 코드를 포함할 수 있다. |

### 2.6.2 날짜

자바스크립트에서 Date 클래스는 몽고DB의 날짜를 표현하는 데 사용한다. 새로운 Date 객체를 생성할 때는 항상 Date()가 아닌 new Date()를 호출해야 한다. 항상 Date 생성자를 사용하도록 주의하지 않으면 문자열과 날짜가 뒤범벅된다.

### 2.6.3 배열

배열은 정렬 연산(list, stack, queue)과 비정렬 연산(set)에 호환성 있게 사용 가능한 값이다.

```jsx
{"things" : ["pie", 3.14]} // 서로 다른 데이터형을 값으로 포함할 수 있다.
```

도큐먼트 내 배열의 장점으로 몽고DB가 배열의 구조를 ‘이해한다’는 점과, 배열의 내용에 작업을 수행하기 위해 내부에 도달하는 방법을 안다는 점이 있다. 따라서 배열에 쿼리하거나 배열의 내용을 이용해 인덱스를 만들 수 있다.

앞 예제에서 몽고DB는 3.14가 “things” 배열의 요소인 모든 도큐먼트를 쿼리한다. 자주쓰는 쿼리라면 “things” 키를 인덱스로 생성하면 쿼리 속도가 향상된다.

### 2.6.4 내장 도큐먼트

도큐먼트는 키에 대한 값이 될 수 있는데 이를 내장 도큐먼트라고 한다.

배열과 마찬가지로 몽고DB는 내장 도큐먼트의 구조를 이해하고, 인덱스를 구성하고, 쿼리하며, 갱신하기 위해 내장 도큐먼트 내부에 접근한다.

하지만 몽고DB에서는 더 많은 데이터 반복이 생길 수 있다는 단점이 있다. 관계형 데이터베이스에서 테이블이 분리가 되어 있다면 분리되어 있는 테이블만 수정하면 되지만 몽고DB에서는 모든 도큐먼트를 수정해야한다.

### 2.6.5 _id와 ObjectId

몽고DB에 저장된 모든 도큐먼트는 “_id” 키를 가진다. “ObjectId”가 기본이다.

**ObjectIds**

자동 증가하는 기본 키처럼 전통적인 것이 아닌 ObjectId를 사용하는 주요 이유는 몽고DB의 분산 특성 때문이다. 여러 서버에 걸쳐 자동으로 증가하는 기본 키를 동기화하는 작업은 어렵고 시간이 걸린다. 몽고DB는 분산 데이터베이스로 설계됐기 때문에 샤딩된 환경에서 고유 식별자를 생성하는 것이 매우 중요했다.

ObjectIdsms 12바이트 스토리지를 사용하며 24자리 16진수 문자열 표현이 가능하다. 바이트당 2자리를 사용한다.

ObjectId 12바이트는 다음과 같이 생성된다.

0 타임스탬프, 1 랜덤, 2 카운터 (랜덤 시작 값), 3, 4, 5, 6, 7, 8, 10, 11

ObjectId의 첫 4바이트는 1970년 1월 1일부터의 시간을 1/1000초 단위로 저장하는 타임스탬프다.

다음 5바이트는 랜덤 값이다. 최종 3바이트는 서로 다른 시스템에서 충돌하는 ObjectId들을 생성하지 않도록 랜덤 값으로 시작하는 카운터다.

**_id 자동 생성**

도큐먼트를 입력할 때 “_id” 키를 명시하지 않으면 입력된 도큐먼트에 키가 자동으로 추가된다. 일반적으로는 클라이언트 쪽 드라이버에서 관리한다.

## 2.7  몽고DB 셸 사용

다른 장비나 포트에 mongod를 연결하려면 셸을 시작할 때 호스트명, 포트, 데이터베이스를 명시해야 한다.

```jsx
$ mongo some-host:30000/myDB
```

### 2.7.1 셸 활용 팁

help를 입력하면 셸에 내장된 도움말을 볼 수 있다.

데이터베이스 수준의 도움말은 db.help()로 컬렉션 수준의 도움말은 db.foo.help()로 확인한다.

함수의 기능을 알고 싶으면 함수명을 괄호 없이 입력하면 된다.

### 2.7.2 셸에서 스크립트 실행하기

셸을 대화형으로 사용하는 방법 외에 다음과 같이 자바스크립트 파일을 셸로 전달해 실행할 수도 있다.

```jsx
mongo script1.js script2.js script3.js
```

mongo 셸은 각 스크립트를 실행하고 빠져나온다.

### 2.7.3 .mongorc.js 만들기

자주 로드되는 스크립트는 .mongorc.js 파일에 넣을 수 있다. 홈 디렉터리에 .mongorc.js 파일을 만들고 추가한다. dropDatabase나 deleteIndexes 같은 함수가 아무것도 수행하지 않게 재정의하거나 모두 선언 해제할 수 있다.

